# This workflow builds and pushes the Docker image to Google Artifact Registry.
# We are using the wedotdd project to host this which doesn't have access to Gemini API so just run tests locally for now

name: Build and Deploy to Artifact Registry
on:
  push:
    branches:
      - main
jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # Setup gcloud CLI
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      #  confirm what identity the runner is actually using
      - name: Who am I (gcloud)
        run: |
          gcloud auth list
          gcloud config list
          gcloud config get-value account
          gcloud config get-value project

      # Configure Docker to use gcloud as a credential helper for Artifact Registry
      - name: Configure Docker
        run: |-
          gcloud auth configure-docker ${{ secrets.GCR_REGION }}-docker.pkg.dev --quiet

      # Build the Docker image
      - name: Build
        run: |-
          docker build \
            --tag "${{ secrets.GCR_REGION }}-docker.pkg.dev/${{ secrets.GCR_PROJECT_ID }}/${{ secrets.GCR_REPOSITORY }}/${{ secrets.GCR_IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}" \
            .

      # Push the Docker image to Artifact Registry
      - name: Publish
        run: |-
          docker push "${{ secrets.GCR_REGION }}-docker.pkg.dev/${{ secrets.GCR_PROJECT_ID }}/${{ secrets.GCR_REPOSITORY }}/${{ secrets.GCR_IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}"

      # Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |-
          gcloud run deploy ${{ secrets.GCR_IMAGE_NAME }} \
            --image "${{ secrets.GCR_REGION }}-docker.pkg.dev/${{ secrets.GCR_PROJECT_ID }}/${{ secrets.GCR_REPOSITORY }}/${{ secrets.GCR_IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}" \
            --region ${{ secrets.GCR_REGION }} \
            --set-env-vars="GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" \
            --platform managed \
            --allow-unauthenticated \
            --cpu 0.08 \
            --memory 128Mi \
            --concurrency 1 \
            --min-instances 0 \
            --max-instances 1 \
            --cpu-throttling \
            --execution-environment gen1
